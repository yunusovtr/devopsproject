# Проектная работа по курсу "DevOps практики и инструменты"

## Тема проектной работы

Создание процесса непрерывной поставки для
приложения с применением Практик CI/CD и быстрой
обратной связью

## Цель работы

Целью проектой работы является демонстрация и закрепление навыков работы с инструментами сборки приложений, их деплоя, а также организация обратной связи в виде сбора метрик и логирования.

## Требования к работе

- Автоматизированные процессы создания и управления платформой
  - Ресурсы Ya.cloud
  - Инфраструктура для CI/CD
  - Инфраструктура для сбора обратной связи
- Использование практики IaC (Infrastructure as Code) для управления конфигурацией и инфраструктурой
- Настроен процесс CI/CD
- Все, что имеет отношение к проекту хранится в Git

## Содержание текущего репозитория

- в директории terraform содержатся манифесты Terraform для разворота кластера Kubernetes в Yandex Cloud с провижинингом установки GitLab в этот кластер с последующей инициализацией в нём двух репозиториев приложения и одного репозитория helm-чартов
- в директории src находится начальный код приложения, состоящего из двух компонентов UI и Crawler, содержащий также код для пайплайнов CI для этих компонентов. Каждый из компонентов в результате провижининга размещается каждый в своём репозитории GitLab.
- в директории src также размещены чарты Helm для деплоя итогового окружения, которые при провижининге переносятся в третий репозиторий GitLab

## Описание приложения

Наименование приложения: Search Engine для поиска ссылок на страницы по словам на этих страницах. Представляется собой два компонента:

- Crawler. Поисковый бот для сбора текстовой информации с веб-страниц и ссылок.

- UI. Веб-интерфейс поиска слов и фраз на проиндексированных ботом Crawler страницах.

Для подробного описания приложения используйте файлы README.md в директориях src/crawler и src/ui.

## Первичное развёртывание

### Требования к локальному компьютеру для запуска первичного развёртывания

ОС: Linux/WSL

Программы:
- Ansible 2.9 ??
- Helm 3
- kubectl 1.24
- jq
- Terraform v.1.2.3
- yc
- git
- nslookup
- curl

### Подготовка к развёртыванию

- Подготовьте домены в сервисе Dynamic DNS сайта https://freedns.afraid.org/ 
  - Подготовьте новую учётную запись на сайте https://freedns.afraid.org/ без закреплённых доменов.
  - Создайте желаемый домен третьего уровня, например yunusovtr.my.to (лучше выбрать не my.to, а любой из предлагаемых редко используемый домен второго уровня типа public, чтобы иметь меньше проблем с выпуском сертификата), прикрепить любой ip-адрес.
  - Создайте поддомены четвёртого уровня к созданному домену третьего уровня строго следующих наименований и строго к тому же айпи, что и домен третьего уровня:
    - gitlab
    - kas
    - minio
    - registry
  - Проверьте, должно было получиться что-то вроде:
    - yunusovtr.my.to
    - gitlab.yunusovtr.my.to
    - kas.yunusovtr.my.to
    - minio.yunusovtr.my.to
    - registry.yunusovtr.my.to
  - Убедитесь, на странице Dynamic DNS опция "Link updates of the same IP together?" должна быть ON
  - Не забудьте добавить логин и пароль от https://freedns.afraid.org/ в файл переменных терраформа в виде переменных afraid_account и afraid_pass.
- Скопируйте файл terraform.tfvars.example в terraform.tfvars и пропишите в нём значения переменных.
- При развёртывании установите VPN соединение с ip-адресом вне России.

### Заполнение переменных Terraform

- cloud_id - id Вашего облака в Yandex Cloud
- folder_id - id каталога используемого в Yandex Cloud для разворачивания ресурсов
- zone - в какой зоне разворачиваются ресурсы? Обычно "ru-central1-a"
- token - токен для доступа к облаку
- node_count - количество нод в разворачиваемом кластере Kubernetes. Достаточно 2.
- public_key_path - путь к публичному ключу. Понадобится для доступа к развёрнутым репозиториям через ssh.
- private_key_path - путь к закрытой части ключа, нужен для инициализации репозитория и загрузки файлов в него
- main_domain - домен третьего уровня, созданный на сайте freedns.afraid.org
- cert_issuer_email - электронная почта для представления выпускатора при подписи сертификата.
- afraid_account - учётная запись freedns.afraid.org с созданным доменом третьего уровня
- afraid_pass - пароль для учётной записи на freedns.afraid.org
- docker_account - учётная запись на docker.com, куда будут заливаться собранные образы приложения.
- docker_pass - пароль для учётной записи на docker.com
- local_repos_dir - локальная директория, куда будут склонированы репозитории, размещенные в развёрнутом окружении.

### Запуск развёртывания

Запустить в корне init.sh

### Процесс развёртывания

Скрипт init.sh

- инициирует директорию терраформ;
- загружает все необходимые модули (для этого нужен айпи за пределами России);
- запускает манифесты терраформа, который создаёт и инициирует создание в Yandex Cloud кластера Kubernetes.

Манифесты Terraform в terraform/managed:

- Создают кластер Kubernetes;
- Запускают скрипты провижининга, которые все исполняются на локальном компьютере

Скрипты провижининга в манифесте Terraform

- Добавляют контекст Kubernetes для доступа к нему из локальной командной строки
- Добавляют нужные репозитории Helm для установки GitLab
- Устанавливают GitLab
- После выдачи ингрессу внешнего айпи меняют на него айпи созданных доменов на сайте freedns.afraid.org
- Выпустив токен для администратора GitLab,
  - создают там группу;
  - создают нужные переменные с нужными значениями в группе;
  - создают репозитории;
  - связывают с репозиториями агенты GitLab с их установкой в кластер;
  - заливают в репозитории файлы;
  - и заливкой файлов инициируют первые процессы пайпланов репозиториев в GitLab;

Пайплайны репозиториев Crawler и UI:

- собирают образы приложения
- размещают образы приложения в официальном реестре docker
- инициируют пайплайн репозитория Deploy (ещё нет)

Пайплайн репозитория Deploy:
- Из размещенных в нём чартов Helm деплоят приложение в тот же кластер Kubernetes с мониторингом и логированием (ещё нет, но задумка такая)

### Результат развёртывания

В результате разворачивания получается кластер Kubernetes в облаке Yandex Cloud, содержащий указанное количество нод.

Этот кластер содержит как инстанс GitLab, так и разворачиваемое приложение.

GitLab со всеми вспомогательными приложениями устанавливается в пространство имён по умолчанию.

Приложение деплоится из GitLab CI в пространство имён app.

Приложение доступно по адресу созданного домена третьего уровня. (ещё нет, если не руками деплоить)

Гитлаб доступен по домену gitlab четвёртого уровня

Мониторинг и логирование доступны по ссылке /grafana домена третьего уровня (пока нет).


### Удаление инфраструктуры

- Запустить в корне destroy.sh

## CHANGE LOG

- Написал тераформ манифест для создания кластера Kubernetes
- Написал провижининг для гитлаб сервера и создания на нём нужных репозиториев с копированием данных
- Написал и испытал Dockerfile для обеих компонент приложения
- Написал пайплайны для сборки образов Crawler и UI
- Написал манифесты Kubernetes для пробного старта приложения
- Подобрал чарты RabbitMQ и MongoDB для рабочего приложения
- Переписал манифесты приложения в чарты Helm (не закончил ещё)
